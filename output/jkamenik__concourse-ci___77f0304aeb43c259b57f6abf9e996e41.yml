# Generated by ansible

version: "2"
services:
  db:
    image: {{ db_version }}
    volumes:
      - "./data:/database"
    environment:
      POSTGRES_DB: {{ db_name }}
      POSTGRES_USER: {{ db_user }}
      POSTGRES_PASSWORD: {{ db_password }}
      PGDATA: /database

  loadbalancer:
    image: "{{ loadbalancer_version }}"
    ports: ["80:80"{% if install_ssl %}, "443:443"{% endif %}]
    links:
      - web
    volumes:
      - "./loadbalancer:/etc/nginx/conf.d"
      - "{{ concourse_log_path }}:/var/log/nginx"
      {% if install_ssl %}- "./ssl:/etc/nginx/ssl"{% endif %}

  web:
    image: {{ concourse_version }}
    links: [db]
    command: web
    ports:
      - "2222:2222"
      - "8080:8080"
    volumes: ["./keys:/concourse-keys"]
    environment:
      CONCOURSE_BASIC_AUTH_USERNAME: {{ concourse_user }}
      CONCOURSE_BASIC_AUTH_PASSWORD: {{ concourse_password }}
      CONCOURSE_EXTERNAL_URL: {{ concourse_url }}
      CONCOURSE_TSA_HOST_KEY: /concourse-keys/tsa_host_key
      CONCOURSE_POSTGRES_DATA_SOURCE: |-
        postgres://{{ db_user }}:{{ db_password }}@db:5432/{{ db_name }}?sslmode=disable
